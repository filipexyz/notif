# leafnode.example.conf â€” Leafnode + subject mapping for external NATS
#
# This example connects notif's NATS to an external NATS server (e.g., Omni)
# via leafnode, with subject mapping for namespace translation.
#
# How it works:
#   1. Leafnode creates a bidirectional connection between NATS servers
#   2. Subject mappings translate between different naming conventions
#   3. Messages flow automatically â€” no application code needed
#
# Architecture:
#   [Omni NATS]                          [notif NATS]
#   message.received.whatsapp.wa-001 --> events.org_default.default.omni.inbound.whatsapp.wa-001
#   message.send.whatsapp.wa-001     <-- events.org_default.default.omni.outbound.whatsapp.wa-001

listen: 0.0.0.0:4222
http_port: 8222

jetstream {
  store_dir: /data
  max_mem: 256MB
  max_file: 1GB
}

# --- Leafnode connection to external NATS ---
leafnodes {
  remotes [
    {
      url: "nats-leaf://omni-nats.example.com:7422"
      # credentials: "/etc/nats/omni.creds"
    }
  ]
}

# --- Subject mapping ---
# Transform subjects at the NATS server level.
# This runs BEFORE messages hit JetStream streams.
#
# Direction: the mapping key is the PUBLISHED subject, the value is what
# subscribers see. For leafnode, subjects arrive as-is from the remote,
# so we map them to our internal namespace.
mappings = {
  # Inbound: Omni publishes "message.received.X" -> notif sees "events.org_default.default.omni.inbound.X"
  "message.received.>" : "events.org_default.default.omni.inbound.>"

  # Outbound: notif publishes "events.org_default.default.omni.outbound.X" -> Omni sees "message.send.X"
  "events.org_default.default.omni.outbound.>" : "message.send.>"
}

# --- Alternative: Account-level imports/exports ---
# For finer-grained control, use NATS accounts with import/export.
# This is more complex but allows per-account isolation.
#
# accounts {
#   NOTIF {
#     users: [{ user: "notif", password: "secret" }]
#     exports: [
#       { stream: "events.org_default.default.omni.outbound.>" }
#     ]
#     imports: [
#       { stream: { account: OMNI, subject: "message.received.>" }, to: "events.org_default.default.omni.inbound.>" }
#     ]
#   }
#   OMNI {
#     users: [{ user: "omni", password: "secret" }]
#     exports: [
#       { stream: "message.received.>" }
#     ]
#     imports: [
#       { stream: { account: NOTIF, subject: "events.org_default.default.omni.outbound.>" }, to: "message.send.>" }
#     ]
#   }
# }
